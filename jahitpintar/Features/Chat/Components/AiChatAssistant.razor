@using jahitpintar.Features.Chat.Models
@using jahitpintar.Features.Customer.Models
@using jahitpintar.Services
@using Microsoft.AspNetCore.Components.Web
@inject IKolosalService KolosalService

<div class="chat-widget">
    @if (_isExpanded)
    {
        <div class="chat-container">
            <div class="chat-header">
                <h6 class="mb-0">
                    <i class="bi bi-robot me-2"></i>AI Assistant
                </h6>
                <button class="btn-close" @onclick="ToggleChat"></button>
            </div>

            <div class="chat-messages">
                @if (_displayMessages.Any())
                {
                    @foreach (var message in _displayMessages)
                    {
                        <div class="message @(message.Role == "user" ? "user-message" : "ai-message")">
                            <div class="message-content">
                                @message.Content
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted p-3">
                        <i class="bi bi-chat-dots"></i>
                        <p class="mb-0">Mulai percakapan dengan AI Assistant</p>
                    </div>
                }

                @if (_isLoading)
                {
                    <div class="message ai-message">
                        <div class="message-content">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="chat-input">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Ketik pesan Anda..."
                           @bind="_newMessage"
                           @onkeypress="HandleKeyPress"
                           disabled="@_isLoading"/>
                    <button class="btn btn-primary"
                            @onclick="SendMessage"
                            disabled="@(_isLoading || string.IsNullOrWhiteSpace(_newMessage))">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <button class="chat-toggle" @onclick="ToggleChat">
            <i class="bi bi-chat-dots"></i>
        </button>
    }
</div>

@code {
    [Parameter] public Customer? Customer { get; set; }

    private bool _isExpanded;
    private bool _isLoading;
    private string _newMessage = string.Empty;

    private readonly List<ChatMessage> _messages = new();

    // Display messages excludes the system prompt
    private readonly List<ChatMessage> _displayMessages = new();

    protected override void OnInitialized()
    {
        InitializeChat();
    }

    private void InitializeChat()
    {
        // Create system prompt based on customer context
        var systemPrompt = CreateSystemPrompt();
        _messages.Add(new ChatMessage { Role = "system", Content = systemPrompt });

        // Add welcome message
        var greeting = "Halo! Saya AI Assistant yang siap membantu Anda dengan informasi dan pertanyaan terkait pelanggan ini. Apa yang bisa saya bantu?";
        var welcomeMsg = new ChatMessage { Role = "assistant", Content = greeting };
        _messages.Add(welcomeMsg);
        _displayMessages.Add(welcomeMsg);
    }

    private string CreateSystemPrompt()
    {
        if (Customer == null)
            return "Anda adalah AI Assistant yang membantu dengan informasi pelanggan. Berikan respons yang helpful dan informatif.";

        var prompt = $@"Anda adalah AI Assistant yang ahli dalam bidang jahit dan konveksi. 
Anda memiliki akses ke informasi pelanggan berikut:

DATA PELANGGAN:
Nama: {Customer.Identity.Name}
Nomor HP: {Customer.Identity.PhoneNumber}
Alamat: {Customer.Identity.Address}

UKURAN BADAN:
- Tinggi: {Customer.Measurements.Height} cm
- Berat: {Customer.Measurements.Weight} kg
- Lingkar Dada: {Customer.Measurements.Upper.ChestCircumference} cm
- Lingkar Pinggang: {Customer.Measurements.Lower.WaistCircumference} cm
- Lingkar Pinggul: {Customer.Measurements.Upper.HipCircumference} cm
- Panjang Lengan: {Customer.Measurements.Upper.SleeveLength} cm
- Panjang Celana/Rok: {Customer.Measurements.Lower.PantsLength} cm

CATATAN TAMBAHAN:
{(string.IsNullOrEmpty(Customer.AdditionalNotes) ? "Tidak ada" : Customer.AdditionalNotes)}

Tugas Anda:
1. Memberikan saran ukuran yang tepat berdasarkan data pelanggan
2. Memberikan tips jahit yang relevan
3. Menjawab pertanyaan tentang pola, bahan, atau teknik jahit
4. Memberikan rekomendasi yang sesuai dengan karakteristik pelanggan

Selalu berikan respons yang helpful, praktis, dan mudah dipahami.";

        return prompt;
    }

    private void ToggleChat()
    {
        _isExpanded = !_isExpanded;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage) || _isLoading)
            return;

        var userMsg = new ChatMessage { Role = "user", Content = _newMessage };
        _messages.Add(userMsg);
        _displayMessages.Add(userMsg);

        var currentMessage = _newMessage;
        _newMessage = string.Empty;
        _isLoading = true;

        try
        {
            var response = await KolosalService.ChatWithAiAsync(_messages);
            var aiMsg = new ChatMessage { Role = "assistant", Content = response };
            _messages.Add(aiMsg);
            _displayMessages.Add(aiMsg);
        }
        catch (Exception ex)
        {
            _displayMessages.Add(new ChatMessage { Role = "assistant", Content = "Maaf, terjadi kesalahan saat menghubungi AI." });
            Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }

}