@using jahitpintar.Features.Chat.Models
@using jahitpintar.Features.Customer.Models
@using jahitpintar.Services
@using Microsoft.AspNetCore.Components.Web
@inject IKolosalService KolosalService

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    @if (_isExpanded)
    {
        <div class="card shadow-lg border-0 rounded-4 chat-container" style="width: 400px; max-width: 90vw; height: 600px; max-height: 80vh;">
            <!-- Chat Header -->
            <div class="card-header bg-primary bg-opacity-10 border-0 py-3 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <div class="avatar-sm bg-primary bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-robot text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-primary">AI Assistant</h6>
                            <small class="text-muted">@(_isLoading ? "Mengetik..." : "Online")</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm rounded-circle" @onclick="ToggleChat" title="Tutup Chat">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="card-body p-0 d-flex flex-column chat-messages">
                @if (_displayMessages.Any())
                {
                    <div class="flex-grow-1 overflow-auto p-3">
                        @foreach (var message in _displayMessages)
                        {
                            <div class="d-flex mb-3 @(message.Role == "user" ? "justify-content-end" : "justify-content-start")">
                                <div class="d-flex flex-column @(message.Role == "user" ? "align-items-end" : "align-items-start")" style="max-width: 80%;">
                                    @if (message.Role == "assistant")
                                    {
                                        <div class="avatar-xs bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mb-1">
                                            <i class="bi bi-robot text-primary" style="font-size: 0.75rem;"></i>
                                        </div>
                                    }
                                    <div class="message-bubble @(message.Role == "user" ? "user-bubble" : "ai-bubble") p-3 rounded-4 @(message.Role == "user" ? "bg-primary text-white" : "bg-light text-dark")">
                                        <p class="mb-0 small">@message.Content</p>
                                    </div>
                                    <small class="text-muted mt-1 px-2">@DateTime.Now.ToString("HH:mm")</small>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                        <div class="text-center text-muted p-4">
                            <div class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                                <i class="bi bi-chat-dots text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <h6 class="mb-2">Mulai Percakapan</h6>
                            <p class="mb-0 small">AI Assistant siap membantu Anda dengan informasi pelanggan</p>
                        </div>
                    </div>
                }

                @if (_isLoading)
                {
                    <div class="px-3 pb-2">
                        <div class="d-flex justify-content-start">
                            <div class="d-flex align-items-end gap-2">
                                <div class="avatar-xs bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-robot text-primary" style="font-size: 0.75rem;"></i>
                                </div>
                                <div class="ai-bubble bg-light p-3 rounded-4">
                                    <div class="typing-indicator d-flex gap-1">
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Chat Input -->
            <div class="card-footer border-0 bg-white rounded-bottom-4 p-3">
                <div class="input-group">
                    <input type="text"
                           class="form-control form-control-lg border-0 bg-light"
                           placeholder="Ketik pesan Anda..."
                           @bind="_newMessage"
                           @onkeypress="HandleKeyPress"
                           disabled="@_isLoading"
                           style="border-radius: 2rem !important;"/>
                    <button class="btn btn-primary btn-lg px-4"
                            @onclick="SendMessage"
                            disabled="@(_isLoading || string.IsNullOrWhiteSpace(_newMessage))"
                            style="border-radius: 2rem; margin-left: -2rem; z-index: 1;">
                        @if (_isLoading)
                        {
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        }
                        else
                        {
                            <i class="bi bi-send"></i>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <button class="btn btn-primary btn-lg rounded-circle shadow chat-toggle p-3" @onclick="ToggleChat" title="Buka Chat Assistant">
            <i class="bi bi-chat-dots fs-4"></i>
        </button>
    }
</div>

@code {
    [Parameter] public Customer? Customer { get; set; }

    private bool _isExpanded;
    private bool _isLoading;
    private string _newMessage = string.Empty;

    private readonly List<ChatMessage> _messages = new();

    // Display messages excludes the system prompt
    private readonly List<ChatMessage> _displayMessages = new();

    protected override void OnInitialized()
    {
        InitializeChat();
    }

    private void InitializeChat()
    {
        // Create system prompt based on customer context
        var systemPrompt = CreateSystemPrompt();
        _messages.Add(new ChatMessage { Role = "system", Content = systemPrompt });

        // Add welcome message
        var greeting = "Halo! Saya AI Assistant yang siap membantu Anda dengan informasi dan pertanyaan terkait pelanggan ini. Apa yang bisa saya bantu?";
        var welcomeMsg = new ChatMessage { Role = "assistant", Content = greeting };
        _messages.Add(welcomeMsg);
        _displayMessages.Add(welcomeMsg);
    }

    private string CreateSystemPrompt()
    {
        if (Customer == null)
            return "Anda adalah AI Assistant yang membantu dengan informasi pelanggan. Berikan respons yang helpful dan informatif.";

        var prompt = $@"Anda adalah AI Assistant yang ahli dalam bidang jahit dan konveksi. 
Anda memiliki akses ke informasi pelanggan berikut:

DATA PELANGGAN:
Nama: {Customer.Identity.Name}
Nomor HP: {Customer.Identity.PhoneNumber}
Alamat: {Customer.Identity.Address}

UKURAN BADAN:
- Tinggi: {Customer.Measurements.Height} cm
- Berat: {Customer.Measurements.Weight} kg
- Lingkar Dada: {Customer.Measurements.Upper.ChestCircumference} cm
- Lingkar Pinggang: {Customer.Measurements.Lower.WaistCircumference} cm
- Lingkar Pinggul: {Customer.Measurements.Upper.HipCircumference} cm
- Panjang Lengan: {Customer.Measurements.Upper.SleeveLength} cm
- Panjang Celana/Rok: {Customer.Measurements.Lower.PantsLength} cm

CATATAN TAMBAHAN:
{(string.IsNullOrEmpty(Customer.AdditionalNotes) ? "Tidak ada" : Customer.AdditionalNotes)}

Tugas Anda:
1. Memberikan saran ukuran yang tepat berdasarkan data pelanggan
2. Memberikan tips jahit yang relevan
3. Menjawab pertanyaan tentang pola, bahan, atau teknik jahit
4. Memberikan rekomendasi yang sesuai dengan karakteristik pelanggan

Selalu berikan respons yang helpful, praktis, dan mudah dipahami.";

        return prompt;
    }

    private void ToggleChat()
    {
        _isExpanded = !_isExpanded;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage) || _isLoading)
            return;

        var userMsg = new ChatMessage { Role = "user", Content = _newMessage };
        _messages.Add(userMsg);
        _displayMessages.Add(userMsg);

        var currentMessage = _newMessage;
        _newMessage = string.Empty;
        _isLoading = true;

        try
        {
            var response = await KolosalService.ChatWithAiAsync(_messages);
            var aiMsg = new ChatMessage { Role = "assistant", Content = response };
            _messages.Add(aiMsg);
            _displayMessages.Add(aiMsg);
        }
        catch (Exception ex)
        {
            _displayMessages.Add(new ChatMessage { Role = "assistant", Content = "Maaf, terjadi kesalahan saat menghubungi AI." });
            Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }

}