@using jahitpintar.Features.Chat.Models
@using jahitpintar.Features.Customer.Models
@using jahitpintar.Services
@using Markdig
@using Microsoft.AspNetCore.Components.Web
@inject IKolosalService KolosalService

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    @if (_isExpanded)
    {
        <div class="card shadow-lg border-0 rounded-4 chat-container"
             style="width: 400px; max-width: 90vw; height: 600px; max-height: 80vh;">
            <!-- Chat Header -->
            <div class="card-header bg-primary bg-opacity-10 border-0 py-3 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <div
                            class="avatar-sm bg-primary bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-robot text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-primary">AI Assistant</h6>
                            <small class="text-muted">@(_isLoading ? "Mengetik..." : "Online")</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm rounded-circle" @onclick="ToggleChat"
                            title="Tutup Chat">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="card-body p-0 d-flex flex-column chat-messages">
                @if (_displayMessages.Any())
                {
                    <div class="flex-grow-1 overflow-auto p-3">
                        @foreach (var message in _displayMessages)
                        {
                            <div
                                class="d-flex mb-3 @(message.Role == "user" ? "justify-content-end" : "justify-content-start")">
                                <div
                                    class="d-flex flex-column @(message.Role == "user" ? "align-items-end" : "align-items-start")"
                                    style="max-width: 80%;">
                                    @if (message.Role == "assistant")
                                    {
                                        <div
                                            class="avatar-xs bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mb-1">
                                            <i class="bi bi-robot text-primary" style="font-size: 0.75rem;"></i>
                                        </div>
                                    }
                                    <div
                                        class="message-bubble @(message.Role == "user" ? "user-bubble" : "ai-bubble") p-3 rounded-4 @(message.Role == "user" ? "bg-primary text-white" : "bg-light text-dark")">
                                        <div class="mb-0 small markdown-content">
                                            @((MarkupString)Markdown.ToHtml(message.Content))
                                        </div>
                                    </div>
                                    <small class="text-muted mt-1 px-2">@DateTime.Now.ToString("HH:mm")</small>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                        <div class="text-center text-muted p-4">
                            <div
                                class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                                <i class="bi bi-chat-dots text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <h6 class="mb-2">Mulai Percakapan</h6>
                            <p class="mb-0 small">AI Assistant siap membantu Anda dengan informasi pelanggan</p>
                        </div>
                    </div>
                }

                @if (_isLoading)
                {
                    <div class="px-3 pb-2">
                        <div class="d-flex justify-content-start">
                            <div class="d-flex align-items-end gap-2">
                                <div
                                    class="avatar-xs bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-robot text-primary" style="font-size: 0.75rem;"></i>
                                </div>
                                <div class="ai-bubble bg-light p-3 rounded-4">
                                    <div class="typing-indicator d-flex gap-1">
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Chat Input -->
            <div class="card-footer border-0 bg-white rounded-bottom-4 p-3">
                <div class="input-group">
                    <input type="text"
                           class="form-control form-control-lg border-0 bg-light"
                           placeholder="Ketik pesan Anda..."
                           @bind="_newMessage"
                           @onkeypress="HandleKeyPress"
                           disabled="@_isLoading"
                           style="border-radius: 2rem !important;"/>
                    <button class="btn btn-primary btn-lg px-4"
                            @onclick="SendMessage"
                            disabled="@(_isLoading || string.IsNullOrWhiteSpace(_newMessage))"
                            style="border-radius: 2rem; margin-left: -2rem; z-index: 1;">
                        @if (_isLoading)
                        {
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        }
                        else
                        {
                            <i class="bi bi-send"></i>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <button class="btn btn-primary btn-lg rounded-circle shadow chat-toggle p-3" @onclick="ToggleChat"
                title="Buka Chat Assistant">
            <i class="bi bi-chat-dots fs-4"></i>
        </button>
    }
</div>

@code {
    [Parameter] public Customer? Customer { get; set; }

    private bool _isExpanded;
    private bool _isLoading;
    private string _newMessage = string.Empty;

    private readonly List<ChatMessage> _messages = new();

    // Display messages excludes the system prompt
    private readonly List<ChatMessage> _displayMessages = new();

    protected override void OnInitialized()
    {
        InitializeChat();
    }

    private void InitializeChat()
    {
        // Create system prompt based on customer context
        var systemPrompt = CreateSystemPrompt();
        _messages.Add(new ChatMessage { Role = "system", Content = systemPrompt });

        // Add welcome message
        var greeting = "Halo! Saya AI Assistant yang siap membantu Anda dengan informasi dan pertanyaan terkait pelanggan ini. Apa yang bisa saya bantu?";
        var welcomeMsg = new ChatMessage { Role = "assistant", Content = greeting };
        _messages.Add(welcomeMsg);
        _displayMessages.Add(welcomeMsg);
    }

    private string CreateSystemPrompt()
    {
        if (Customer == null)
            return "Anda adalah AI Assistant yang membantu dengan informasi pelanggan. Berikan respons yang helpful dan informatif.";

        var prompt = $@"Anda adalah seorang pakar AI Assistant yang sangat menguasai bidang jahit dan konveksi, serta memiliki pemahaman mendalam tentang fashion dan tekstil. 
Tugas Anda adalah:
1. Membantu penjahit profesional menganalisis kebutuhan klien berdasarkan data yang diberikan secara eksplisit untuk sesi ini
1. Memberikan saran ukuran yang tepat berdasarkan data pelanggan
2. Memberikan tips jahit yang relevan
3. Menjawab pertanyaan tentang pola, bahan, atau teknik jahit
4. Memberikan rekomendasi yang sesuai dengan karakteristik pelanggan

PENTING: Jawab dengan SINGKAT dan JELAS (maksimal 3-4 kalimat atau poin per respons). Anda BOLEH menggunakan format Markdown seperti **bold** atau daftar (bullet points) untuk memperjelas informasi.

DATA UKURAN PELANGGAN (Data ini aman untuk digunakan dalam analisis):
Nama: {Customer.Identity.Name}

UKURAN BADAN (Body Measurements):
- Tinggi Badan: {Customer.Measurements.Height} cm
- Berat Badan: {Customer.Measurements.Weight} kg

ATASAN (Upper Body):
- Lingkar Dada (LD): {Customer.Measurements.Upper.ChestCircumference} cm
- Lingkar Pinggang (Upper): {Customer.Measurements.Upper.WaistCircumference} cm
- Lingkar Pinggul: {Customer.Measurements.Upper.HipCircumference} cm
- Lingkar Leher: {Customer.Measurements.Upper.NeckCircumference} cm
- Lebar Bahu: {Customer.Measurements.Upper.ShoulderWidth} cm
- Panjang Lengan: {Customer.Measurements.Upper.SleeveLength} cm
- Lingkar Kerung Lengan: {Customer.Measurements.Upper.ArmholeCircumference} cm
- Lingkar Lengan: {Customer.Measurements.Upper.ArmCircumference} cm
- Lingkar Pergelangan: {Customer.Measurements.Upper.WristCircumference} cm
- Lebar Muka: {Customer.Measurements.Upper.FrontWidth} cm
- Lebar Punggung: {Customer.Measurements.Upper.BackWidth} cm
- Tinggi Pinggul: {Customer.Measurements.Upper.HipHeight} cm
- Panjang Baju: {Customer.Measurements.Upper.ShirtLength} cm

BAWAHAN (Lower Body):
- Lingkar Pinggang (Lower): {Customer.Measurements.Lower.WaistCircumference} cm
- Lingkar Pesak: {Customer.Measurements.Lower.CrotchCircumference} cm
- Lingkar Paha: {Customer.Measurements.Lower.ThighCircumference} cm
- Lingkar Lutut: {Customer.Measurements.Lower.KneeCircumference} cm
- Lingkar Kaki: {Customer.Measurements.Lower.AnkleCircumference} cm
- Panjang Celana/Rok: {Customer.Measurements.Lower.PantsLength} cm
- Tinggi Duduk: {Customer.Measurements.Lower.SeatedHeight} cm

PREFERENSI:
- Warna Favorit: {Customer.Preferences.FavoriteColor}
- Ukuran Baju Favorit: {Customer.Preferences.PreferredSize}
- Gaya Favorit: {Customer.Preferences.PreferredStyle}

CATATAN TAMBAHAN:
{(string.IsNullOrEmpty(Customer.AdditionalNotes) ? "Tidak ada" : Customer.AdditionalNotes)}";

        return prompt;
    }

    private void ToggleChat()
    {
        _isExpanded = !_isExpanded;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage) || _isLoading)
            return;

        var userMsg = new ChatMessage { Role = "user", Content = _newMessage };
        _messages.Add(userMsg);
        _displayMessages.Add(userMsg);

        var currentMessage = _newMessage;
        _newMessage = string.Empty;
        _isLoading = true;

        try
        {
            var response = await KolosalService.ChatWithAiAsync(_messages);
            var aiMsg = new ChatMessage { Role = "assistant", Content = response };
            _messages.Add(aiMsg);
            _displayMessages.Add(aiMsg);
        }
        catch (Exception ex)
        {
            _displayMessages.Add(new ChatMessage { Role = "assistant", Content = "Maaf, terjadi kesalahan saat menghubungi AI." });
            Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }

}