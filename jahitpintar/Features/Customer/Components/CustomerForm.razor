@page "/customers/add"
@page "/customers/edit/{Id}"
@using jahitpintar.Features.Ocr.Services
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IKolosalService KolosalService
@inject ICustomerService CustomerService
@inject IOcrService OcrService
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime
@rendermode InteractiveServer

<PageTitle>@(string.IsNullOrEmpty(Id) ? "Tambah Pelanggan" : "Edit Pelanggan")</PageTitle>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@(string.IsNullOrEmpty(Id) ? "Tambah Pelanggan Baru" : "Edit Data Pelanggan")</h1>
        <a href="/customers" class="btn btn-outline-secondary">Kembali</a>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger">@_errorMessage</div>
    }
    else
    {
        <!-- Smart Input Section -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-magic"></i> Input Cerdas (AI)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h5><i class="bi bi-camera"></i> Scan Catatan Lama</h5>
                        <p class="text-muted small">Upload foto catatan tangan ukuran pelanggan.</p>
                        <InputFile OnChange="HandleFileUpload" accept=".jpg,.jpeg,.png,.pdf" class="form-control"/>
                        @if (_isOcrProcessing)
                        {
                            <div class="mt-2 text-primary">Sedang memproses gambar...</div>
                        }
                    </div>
                    <div class="col-md-6 mb-3">
                        <h5><i class="bi bi-chat-dots"></i> Input via Chat</h5>
                        <p class="text-muted small">Ketik data pelanggan secara natural (contoh: "Pak Budi, LD 100,
                            Alamat Kemang").</p>
                        <div class="input-group">
                            <textarea @bind="_chatInput" class="form-control" placeholder="Ketik di sini..."
                                      rows="2"></textarea>
                            <button class="btn btn-outline-primary" @onclick="ProcessChatInput"
                                    disabled="@_isChatProcessing">
                                @(_isChatProcessing ? "..." : "Proses")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <EditForm Model="_customer" OnValidSubmit="SaveCustomer">
            <DataAnnotationsValidator/>
            <!-- Identity Section -->
            <div class="card mb-3">
                <div class="card-header">A. Data Identitas</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <InputText @bind-Value="_customer.Identity.Name" class="form-control"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nomor Handphone</label>
                            <InputText @bind-Value="_customer.Identity.PhoneNumber" class="form-control"
                                       placeholder="Contoh: 08123456789"/>
                            <div class="mt-2">
                                <label class="form-label small text-muted">Sosial Media (Centang jika aktif):</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    @foreach (var platform in new[] { "WhatsApp", "Telegram", "Signal", "Line" })
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   checked="@_customer.Identity.SocialMediaPlatforms.Contains(platform)"
                                                   @onchange="@(e => ToggleSocialMedia(platform, e))"/>
                                            <label class="form-check-label">@platform</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Alamat Lengkap</label>
                            <InputTextArea @bind-Value="_customer.Identity.Address" class="form-control" rows="2"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Measurements Section -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>B. Data Ukuran Badan</span>
                </div>
                <div class="card-body">
                    <h6 class="text-primary mt-2">Atasan (Upper Body)</h6>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Dada (LD)</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.ChestCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Pinggang</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.WaistCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Pinggul</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.HipCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Leher</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.NeckCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lebar Bahu</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.ShoulderWidth" class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Panjang Lengan</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.SleeveLength" class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Kerung Lengan</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.ArmholeCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Lengan</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.ArmCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Pergelangan</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.WristCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lebar Muka</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.FrontWidth" class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lebar Punggung</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.BackWidth" class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Tinggi Pinggul</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.HipHeight" class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Panjang Baju</label>
                            <InputNumber @bind-Value="_customer.Measurements.Upper.ShirtLength" class="form-control"/>
                        </div>
                    </div>

                    <h6 class="text-primary mt-3">Bawahan (Lower Body)</h6>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Pinggang Celana / Rok</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.WaistCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Pesak</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.CrotchCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Paha</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.ThighCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Lutut</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.KneeCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Lingkar Kaki</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.AnkleCircumference"
                                         class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Panjang Celana / Rok</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.PantsLength" class="form-control"/>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Tinggi Duduk</label>
                            <InputNumber @bind-Value="_customer.Measurements.Lower.SeatedHeight" class="form-control"/>
                        </div>
                    </div>

                    <h6 class="text-primary mt-3">Tambahan</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Tinggi Badan (cm)</label>
                            <InputNumber @bind-Value="_customer.Measurements.Height" class="form-control"/>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Berat Badan (kg)</label>
                            <InputNumber @bind-Value="_customer.Measurements.Weight" class="form-control"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preferences Section -->
            <div class="card mb-3">
                <div class="card-header">C. Catatan Tambahan</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <InputTextArea @bind-Value="_customer.AdditionalNotes" class="form-control" rows="4"
                                           placeholder="Jenis kain, model baju, pesanan khusus, dll..."/>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
                @if (!string.IsNullOrEmpty(Id))
                {
                    <button type="button" class="btn btn-outline-danger btn-lg me-md-2" @onclick="DeleteCustomer"
                            disabled="@_isSaving">
                        Hapus
                    </button>
                }
                <button type="submit" class="btn btn-primary btn-lg" disabled="@_isSaving">
                    @(_isSaving ? "Menyimpan..." : "Simpan Data Pelanggan")
                </button>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public string? Id { get; set; }

    private Customer _customer = new();
    private ApplicationUser? _user;

    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isOcrProcessing;
    private bool _isChatProcessing;
    private string? _errorMessage;
    private string _chatInput = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var principal = authState.User;

            if (principal.Identity?.IsAuthenticated == true)
            {
                _user = await UserManager.GetUserAsync(principal);
                if (_user != null)
                {
                    if (!string.IsNullOrEmpty(Id))
                    {
                        var found = await CustomerService.GetCustomerByIdAsync(Id);
                        if (found != null)
                        {
                            if (found.UserId != _user.Id && !string.IsNullOrEmpty(found.UserId))
                            {
                                _errorMessage = "Unauthorized access.";
                            }
                            else
                            {
                                _customer = found;
                            }
                        }
                        else
                        {
                            _errorMessage = "Pelanggan tidak ditemukan.";
                        }
                    }
                }
                else
                {
                    _errorMessage = "User tidak ditemukan.";
                }
            }
            else
            {
                _errorMessage = "Anda harus login.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        _isOcrProcessing = true;
        try
        {
            var file = e.File;
            var maxFileSize = 1024 * 1024 * 5; // 5MB

            await using var stream = file.OpenReadStream(maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            // 1. OCR Extraction using OcrService
            var ocrResult = await OcrService.RecognizeFormAsync(ms, file.Name);

            // 2. Parse with AI
            if (ocrResult != null && !string.IsNullOrWhiteSpace(ocrResult.ExtractedText))
            {
                var extractedData = await KolosalService.ExtractCustomerFromTextAsync(ocrResult.ExtractedText);
                MergeCustomerData(extractedData);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"OCR Failed: {ex.Message}";
        }
        finally
        {
            _isOcrProcessing = false;
        }
    }

    private async Task ProcessChatInput()
    {
        if (string.IsNullOrWhiteSpace(_chatInput)) return;

        _isChatProcessing = true;
        try
        {
            var extractedData = await KolosalService.ExtractCustomerFromTextAsync(_chatInput);
            MergeCustomerData(extractedData);
            _chatInput = ""; // Clear input
        }
        catch (Exception ex)
        {
            _errorMessage = $"AI Processing Failed: {ex.Message}";
        }
        finally
        {
            _isChatProcessing = false;
        }
    }

    private void ToggleSocialMedia(string platform, ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            if (!_customer.Identity.SocialMediaPlatforms.Contains(platform))
            {
                _customer.Identity.SocialMediaPlatforms.Add(platform);
            }
        }
        else
        {
            _customer.Identity.SocialMediaPlatforms.Remove(platform);
        }
    }

    private void MergeCustomerData(Customer extracted)
    {
        // intelligently merge non-null/non-default values
        if (!string.IsNullOrEmpty(extracted.Identity.Name)) _customer.Identity.Name = extracted.Identity.Name;
        if (!string.IsNullOrEmpty(extracted.Identity.Address)) _customer.Identity.Address = extracted.Identity.Address;
        if (!string.IsNullOrEmpty(extracted.Identity.PhoneNumber)) _customer.Identity.PhoneNumber = extracted.Identity.PhoneNumber;

        // Merge Social Media
        if (extracted.Identity.SocialMediaPlatforms.Any())
        {
            foreach (var platform in extracted.Identity.SocialMediaPlatforms)
            {
                if (!_customer.Identity.SocialMediaPlatforms.Contains(platform))
                {
                    _customer.Identity.SocialMediaPlatforms.Add(platform);
                }
            }
        }

        // Measurements
        // Upper
        if (extracted.Measurements.Upper.ChestCircumference > 0) _customer.Measurements.Upper.ChestCircumference = extracted.Measurements.Upper.ChestCircumference;
        if (extracted.Measurements.Upper.WaistCircumference > 0) _customer.Measurements.Upper.WaistCircumference = extracted.Measurements.Upper.WaistCircumference;
        if (extracted.Measurements.Upper.HipCircumference > 0) _customer.Measurements.Upper.HipCircumference = extracted.Measurements.Upper.HipCircumference;
        if (extracted.Measurements.Upper.NeckCircumference > 0) _customer.Measurements.Upper.NeckCircumference = extracted.Measurements.Upper.NeckCircumference;
        if (extracted.Measurements.Upper.ShoulderWidth > 0) _customer.Measurements.Upper.ShoulderWidth = extracted.Measurements.Upper.ShoulderWidth;
        if (extracted.Measurements.Upper.SleeveLength > 0) _customer.Measurements.Upper.SleeveLength = extracted.Measurements.Upper.SleeveLength;
        if (extracted.Measurements.Upper.ArmholeCircumference > 0) _customer.Measurements.Upper.ArmholeCircumference = extracted.Measurements.Upper.ArmholeCircumference;
        if (extracted.Measurements.Upper.ArmCircumference > 0) _customer.Measurements.Upper.ArmCircumference = extracted.Measurements.Upper.ArmCircumference;
        if (extracted.Measurements.Upper.WristCircumference > 0) _customer.Measurements.Upper.WristCircumference = extracted.Measurements.Upper.WristCircumference;
        if (extracted.Measurements.Upper.FrontWidth > 0) _customer.Measurements.Upper.FrontWidth = extracted.Measurements.Upper.FrontWidth;
        if (extracted.Measurements.Upper.BackWidth > 0) _customer.Measurements.Upper.BackWidth = extracted.Measurements.Upper.BackWidth;
        if (extracted.Measurements.Upper.HipHeight > 0) _customer.Measurements.Upper.HipHeight = extracted.Measurements.Upper.HipHeight;
        if (extracted.Measurements.Upper.ShirtLength > 0) _customer.Measurements.Upper.ShirtLength = extracted.Measurements.Upper.ShirtLength;

        // Lower
        if (extracted.Measurements.Lower.WaistCircumference > 0) _customer.Measurements.Lower.WaistCircumference = extracted.Measurements.Lower.WaistCircumference;
        if (extracted.Measurements.Lower.HipCircumference > 0) _customer.Measurements.Lower.HipCircumference = extracted.Measurements.Lower.HipCircumference;
        if (extracted.Measurements.Lower.LegLength > 0) _customer.Measurements.Lower.LegLength = extracted.Measurements.Lower.LegLength;
        if (extracted.Measurements.Lower.ThighCircumference > 0) _customer.Measurements.Lower.ThighCircumference = extracted.Measurements.Lower.ThighCircumference;
        if (extracted.Measurements.Lower.CrotchCircumference > 0) _customer.Measurements.Lower.CrotchCircumference = extracted.Measurements.Lower.CrotchCircumference;
        if (extracted.Measurements.Lower.KneeCircumference > 0) _customer.Measurements.Lower.KneeCircumference = extracted.Measurements.Lower.KneeCircumference;
        if (extracted.Measurements.Lower.AnkleCircumference > 0) _customer.Measurements.Lower.AnkleCircumference = extracted.Measurements.Lower.AnkleCircumference;
        if (extracted.Measurements.Lower.PantsLength > 0) _customer.Measurements.Lower.PantsLength = extracted.Measurements.Lower.PantsLength;
        if (extracted.Measurements.Lower.SeatedHeight > 0) _customer.Measurements.Lower.SeatedHeight = extracted.Measurements.Lower.SeatedHeight;

        // General
        if (extracted.Measurements.Height > 0) _customer.Measurements.Height = extracted.Measurements.Height;
        if (extracted.Measurements.Weight > 0) _customer.Measurements.Weight = extracted.Measurements.Weight;

        // Additional Notes
        if (!string.IsNullOrWhiteSpace(extracted.AdditionalNotes))
        {
            if (!string.IsNullOrWhiteSpace(_customer.AdditionalNotes))
            {
                _customer.AdditionalNotes += "\n" + extracted.AdditionalNotes;
            }
            else
            {
                _customer.AdditionalNotes = extracted.AdditionalNotes;
            }
        }

        StateHasChanged();
    }

    private async Task DeleteCustomer()
    {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", "Apakah Anda yakin ingin menghapus data pelanggan ini?"))
        {
            return;
        }

        _isSaving = true;
        try
        {
            if (!string.IsNullOrEmpty(Id))
            {
                await CustomerService.DeleteCustomerAsync(Id);
                NavigationManager.NavigateTo("/customers");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Gagal menghapus: {ex.Message}";
            _isSaving = false;
        }
    }

    private async Task SaveCustomer()
    {
        if (_user == null) return;

        _isSaving = true;
        try
        {
            await CustomerService.SaveCustomerAsync(_customer, _user.Id);
            NavigationManager.NavigateTo("/customers");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to save: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

}
