@page "/customers/details/{Id}"
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ICustomerService CustomerService
@rendermode InteractiveServer

<PageTitle>Detail Pelanggan</PageTitle>

<div class="container-fluid py-4">
    <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div class="d-flex flex-column">
            <h1 class="h2 mb-1 fw-bold text-primary">Detail Pelanggan</h1>
            <small class="text-muted">Informasi lengkap data pelanggan</small>
        </div>
        <a href="/customers" class="btn btn-outline-secondary d-flex align-items-center gap-2 shadow-sm">
            <i class="bi bi-arrow-left"></i> Kembali
        </a>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger">@_errorMessage</div>
    }
    else if (_customer != null)
    {
        <!-- Identity Section -->
        <div class="card shadow-sm border-0 mb-4 rounded-4">
            <div class="card-header bg-primary bg-opacity-10 border-0 py-3">
                <h5 class="mb-0 fw-bold text-primary">
                    <i class="bi bi-person-vcard me-2"></i>Data Identitas
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-1">Nama Lengkap</small>
                            <h6 class="fw-bold text-dark mb-0">@_customer.Identity.Name</h6>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-1">Nomor Handphone</small>
                            <h6 class="fw-bold text-dark mb-0">@_customer.Identity.PhoneNumber</h6>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-2">Sosial Media</small>
                            @if (_customer.Identity.SocialMediaPlatforms.Any())
                            {
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var platform in _customer.Identity.SocialMediaPlatforms)
                                    {
                                        <span
                                            class="badge bg-info-subtle text-info-emphasis border border-info-subtle px-3 py-2">
                                            <i class="bi bi-chat-dots me-1"></i>@platform
                                        </span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted fst-italic">Tidak ada platform sosial media</span>
                            }
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-1">Alamat Lengkap</small>
                            <h6 class="fw-bold text-dark mb-0">@_customer.Identity.Address</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Measurements Section -->
        <div class="card shadow-sm border-0 mb-4 rounded-4">
            <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                <h5 class="mb-0 fw-bold text-success">
                    <i class="bi bi-rulers me-2"></i>Data Ukuran Badan
                </h5>
            </div>
            <div class="card-body p-4">

                <!-- Upper Body -->
                <div class="bg-primary-subtle border border-primary-subtle rounded-3 p-4 mb-4">
                    <h6 class="text-primary fw-bold border-bottom border-primary border-opacity-25 pb-3 mb-4 d-flex align-items-center">
                        <i class="bi bi-arrow-up-circle me-2 fs-5"></i>Atasan (Upper Body)
                    </h6>
                    <div class="row g-4">
                        <div class="col-12 col-lg-6">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Dada (LD)</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.ChestCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Pinggang</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.WaistCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Pinggul</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.HipCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Leher</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.NeckCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lebar Bahu</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.ShoulderWidth)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Panjang Lengan</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.SleeveLength)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Kerung Lengan</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.ArmholeCircumference)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Lengan</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.ArmCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Pergelangan</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.WristCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lebar Muka</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.FrontWidth)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lebar Punggung</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.BackWidth)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Tinggi Pinggul</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.HipHeight)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Panjang Baju</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Upper.ShirtLength)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lower Body -->
                <div class="bg-warning-subtle border border-warning-subtle rounded-3 p-4 mb-4">
                    <h6 class="text-warning-emphasis fw-bold border-bottom border-warning border-opacity-25 pb-3 mb-4 d-flex align-items-center">
                        <i class="bi bi-arrow-down-circle me-2 fs-5"></i>Bawahan (Lower Body)
                    </h6>
                    <div class="row g-4">
                        <div class="col-12 col-lg-6">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Pinggang</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.WaistCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Pesak</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.CrotchCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Paha</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.ThighCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Lutut</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.KneeCircumference)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Lingkar Kaki</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.AnkleCircumference)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Panjang Celana/Rok</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.PantsLength)</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div
                                        class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                        <small class="text-muted text-uppercase fw-bold">Tinggi Duduk</small>
                                        <span
                                            class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Lower.SeatedHeight)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional -->
                <div class="bg-info-subtle border border-info-subtle rounded-3 p-4">
                    <h6 class="text-info-emphasis fw-bold border-bottom border-info border-opacity-25 pb-3 mb-4 d-flex align-items-center">
                        <i class="bi bi-plus-circle me-2 fs-5"></i>Tambahan
                    </h6>
                    <div class="row g-4">
                        <div class="col-12 col-md-6">
                            <div
                                class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                <small class="text-muted text-uppercase fw-bold">Tinggi Badan</small>
                                <span class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Height)</span>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div
                                class="d-flex justify-content-between align-items-center p-3 bg-white bg-opacity-50 rounded-2">
                                <small class="text-muted text-uppercase fw-bold">Berat Badan</small>
                                <span
                                    class="fw-bold text-dark">@FormatMeasurement(_customer.Measurements.Weight, "kg")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences Section -->
        <div class="card shadow-sm border-0 mb-4 rounded-4">
            <div class="card-header bg-info bg-opacity-10 border-0 py-3">
                <h5 class="mb-0 fw-bold text-info">
                    <i class="bi bi-heart me-2"></i>Preferensi & Catatan
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-4 mb-4">
                    <div class="col-12 col-md-4">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-1">Warna Favorit</small>
                            <h6 class="fw-bold text-dark mb-0">@(!string.IsNullOrEmpty(_customer.Preferences.FavoriteColor) ? _customer.Preferences.FavoriteColor : "-")</h6>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-1">Ukuran Baju</small>
                            <h6 class="fw-bold text-dark mb-0">@(!string.IsNullOrEmpty(_customer.Preferences.PreferredSize) ? _customer.Preferences.PreferredSize : "-")</h6>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="d-flex flex-column">
                            <small class="text-muted text-uppercase fw-bold mb-1">Gaya Favorit</small>
                            <h6 class="fw-bold text-dark mb-0">@(!string.IsNullOrEmpty(_customer.Preferences.PreferredStyle) ? _customer.Preferences.PreferredStyle : "-")</h6>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-column">
                    <small class="text-muted text-uppercase fw-bold mb-2">Catatan Tambahan</small>
                    <div class="p-4 bg-light-subtle rounded-3 border border-light-subtle">
                        <p class="card-text mb-0 text-dark"
                           style="white-space: pre-wrap;">@(!string.IsNullOrEmpty(_customer.AdditionalNotes) ? _customer.AdditionalNotes : "Tidak ada catatan tambahan.")</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-5">
            <a href="/customers/edit/@_customer.Id"
               class="btn btn-warning btn-lg px-5 shadow-sm d-flex align-items-center gap-2">
                <i class="bi bi-pencil-square"></i>Edit Data
            </a>
        </div>
    }

    <AiChatAssistant Customer="@_customer"/>
</div>

@code {
    [Parameter] public string Id { get; set; } = "";

    private Customer? _customer;
    private ApplicationUser? _user;
    private bool _isLoading = true;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var principal = authState.User;

            if (principal.Identity?.IsAuthenticated == true)
            {
                _user = await UserManager.GetUserAsync(principal);
                if (_user != null)
                {
                    if (!string.IsNullOrEmpty(Id))
                    {
                        var found = await CustomerService.GetCustomerByIdAsync(Id);
                        if (found != null)
                        {
                            if (found.UserId != _user.Id && !string.IsNullOrEmpty(found.UserId))
                            {
                                _errorMessage = "Unauthorized access.";
                            }
                            else
                            {
                                _customer = found;
                            }
                        }
                        else
                        {
                            _errorMessage = "Pelanggan tidak ditemukan.";
                        }
                    }
                }
                else
                {
                    _errorMessage = "User tidak ditemukan.";
                }
            }
            else
            {
                _errorMessage = "Anda harus login.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string FormatMeasurement(double value, string unit = "cm")
    {
        return value > 0 ? $"{value} {unit}" : "-";
    }

}