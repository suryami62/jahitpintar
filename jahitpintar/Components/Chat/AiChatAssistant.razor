@using jahitpintar.Models
@using jahitpintar.Services
@using System.Text.Json
@inject IKolosalService KolosalService
@inject IJSRuntime JS

<div class="ai-chat-container">
    @if (_isOpen)
    {
        <div class="card shadow ai-chat-window">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-robot me-2"></i>Asisten AI</h6>
                <button type="button" class="btn-close btn-close-white" @onclick="ToggleChat"></button>
            </div>
            <div class="card-body p-3 chat-messages" id="chat-messages">
                @foreach (var msg in _displayMessages)
                {
                    <div class="d-flex mb-3 @(msg.Role == "user" ? "justify-content-end" : "justify-content-start")">
                        <div class="@(msg.Role == "user" ? "bg-primary text-white" : "bg-light text-dark") p-2 rounded shadow-sm" style="max-width: 80%;">
                            @msg.Content
                        </div>
                    </div>
                }
                @if (_isLoading)
                {
                     <div class="d-flex mb-3 justify-content-start">
                        <div class="bg-light text-dark p-2 rounded shadow-sm">
                            <div class="spinner-dots">
                                <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                                <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                                <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="card-footer p-2">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Tanya tentang pelanggan..." @bind="_newMessage" @bind:event="oninput" @onkeypress="HandleKeyPress" />
                    <button class="btn btn-primary" type="button" @onclick="SendMessage" disabled="@(_isLoading || string.IsNullOrWhiteSpace(_newMessage))">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    }

    <button class="btn btn-primary rounded-circle shadow-lg ai-chat-toggle p-3" @onclick="ToggleChat">
        <i class="bi bi-chat-dots-fill fs-4"></i>
    </button>
</div>

<style>
    .ai-chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
    }
    .ai-chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 400px;
        display: flex;
        flex-direction: column;
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
    }
    .ai-chat-toggle {
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>

@code {
    [Parameter] public Customer? Customer { get; set; }

    private bool _isOpen = false;
    private string _newMessage = "";
    private bool _isLoading = false;
    private List<ChatMessage> _messages = new();
    // Display messages excludes the system prompt
    private List<ChatMessage> _displayMessages = new();

    private void ToggleChat()
    {
        _isOpen = !_isOpen;
        if (_isOpen && _messages.Count == 0)
        {
            InitializeChat();
        }
    }

    protected override void OnParametersSet()
    {
        // If customer changes while chat is open, maybe re-initialize?
        // For now, let's keep it simple. Only initialize if empty.
    }

    private void InitializeChat()
    {
        _messages.Clear();
        _displayMessages.Clear();

        var systemPrompt = "Kamu adalah asisten AI yang membantu penjahit. Jawab pertanyaan dengan sopan, singkat, dan padat. Jangan gunakan format Markdown (seperti **tebal**, ## heading, atau list -), gunakan teks biasa paragraf saja. ";
        
        if (Customer != null)
        {
            var options = new JsonSerializerOptions { WriteIndented = true };
            var customerData = JsonSerializer.Serialize(Customer, options);
            systemPrompt += $"Kamu sedang melihat data pelanggan berikut:\n{customerData}\n\nGunakan data ini untuk menjawab pertanyaan pengguna tentang ukuran, preferensi, atau identitas pelanggan.";
        }
        else 
        {
            systemPrompt += "Kamu siap membantu menjawab pertanyaan umum seputar menjahit.";
        }

        _messages.Add(new ChatMessage { Role = "system", Content = systemPrompt });
        
        // Add a greeting from assistant
        var greeting = Customer != null 
            ? $"Halo! Ada yang bisa saya bantu mengenai data pelanggan {Customer.Identity.Name}?" 
            : "Halo! Ada yang bisa saya bantu?";
            
        var welcomeMsg = new ChatMessage { Role = "assistant", Content = greeting };
        _messages.Add(welcomeMsg);
        _displayMessages.Add(welcomeMsg);
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage)) return;

        var userMsg = new ChatMessage { Role = "user", Content = _newMessage };
        _messages.Add(userMsg);
        _displayMessages.Add(userMsg);
        var msgToSend = _newMessage;
        _newMessage = "";
        _isLoading = true;
        
        // Scroll to bottom
        await ScrollToBottom();

        try
        {
            var response = await KolosalService.ChatWithAiAsync(_messages);
            var aiMsg = new ChatMessage { Role = "assistant", Content = response };
            _messages.Add(aiMsg);
            _displayMessages.Add(aiMsg);
        }
        catch (Exception ex)
        {
            _displayMessages.Add(new ChatMessage { Role = "assistant", Content = "Maaf, terjadi kesalahan saat menghubungi AI." });
             Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
            await ScrollToBottom();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    private async Task ScrollToBottom()
    {
        // Simple JS interop to scroll to bottom
        try {
            // Need to wait for render
            await Task.Delay(50); 
            await JS.InvokeVoidAsync("eval", "var el = document.getElementById('chat-messages'); if(el) el.scrollTop = el.scrollHeight;");
        } catch {}
    }
}
